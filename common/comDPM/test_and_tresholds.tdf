TITLE "DCOM test signals, K.-H. Sulanke,DESY Zeuthen, 2005-08-26";
-- plus comm. and DAC level control tresholds
-- see DC_CTRAP.dia, extra transition tcal_rcvd from state DRREQ_WT introduced 

CONSTANT DCFREV		= 026;			-- DOM Communication module revision (dec.)

CONSTANT LOW_THRESH	=  66;	--77;	-- HL-edge length after 6 clocks, weak signal (long cable)
CONSTANT LRG_THRESH	= 255;	-- HL-edge length after 3 clocks, strong signal (short cable)
CONSTANT LOW_STEP	=   6;	--7;	-- difference after consecutive ADC samples, weak signal (long cable)
CONSTANT LRG_STEP	=  55;	-- difference after consecutive ADC samples, strong signal (short cable)
CONSTANT MIN_CLEV	= 960;	-- needed for comm. DAC level adaption
CONSTANT MAX_CLEV	= 970;	-- needed for comm. DAC level adaption

SUBDESIGN test_and_tresholds
(
--	stf_stb			: INPUT;
--	data_stb		: INPUT;
--	eof_stb			: INPUT;
--	comres_rcvd		: INPUT;	
--	lh_edge			: INPUT;
--	data_error		: INPUT;
--	ctrl_msg		: INPUT;
--	data_msg		: INPUT;	
--	crc_zero		: INPUT;
--	rx_addr[1..0]	: INPUT;
--	tx_dataout[15..12]	: INPUT;
--	rx_we			: INPUT;
--	drreq_rcvd		: INPUT;
--	tx_empty		: INPUT;
--	tx_alm_empty	: INPUT;	
--	tx_pack_sent	: INPUT;
--	tx_dpr_ren		: INPUT;
--	send_data		: INPUT;
--	tx_pack_rdy		: INPUT;
	
	reboot_req		: INPUT;
	drreq_rcvd		: INPUT;
	idle_rcvd		: INPUT;	
--	reboot_gnt		: INPUT;
--	com_avail		: INPUT;
	buf_res			: INPUT;
--	data_error		: INPUT;
	ctrl_error		: INPUT;
	tcal_rcvd		: INPUT;
	pulse_rcvd		: INPUT;
	pulse_sent		: INPUT;
	
	
	tc[7..0]		: OUTPUT;	-- DOM test connector
	
	low_thr[7..0]	: OUTPUT;	-- HL-edge length after 6 clocks
	lrg_thr[9..0]	: OUTPUT;	-- HL-edge length after 3 clocks
	low_stp[3..0]	: OUTPUT;	-- difference between consecutice comm. ADC samples	
	lrg_stp[7..0]	: OUTPUT;	-- difference between consecutice comm. ADC samples	

	clev_min[9..0]	: OUTPUT;	-- needed for comm. DAC level adaption
	clev_max[9..0]	: OUTPUT;	-- needed for comm. DAC level adaption
	rev[15..0]		: OUTPUT;	-- DOM comm. module revision
)

BEGIN

	tc[0]	= reboot_req;
	tc[1]	= drreq_rcvd;
	tc[2]	= idle_rcvd;
	tc[3]	= ctrl_error;
	tc[4]	= buf_res;
	tc[5]	= tcal_rcvd;
	tc[6]	= pulse_rcvd;
	tc[7]	= pulse_sent;
--	tc[0]	= comres_rcvd;
--	tc[1]	= drreq_rcvd;
--	tc[2]	= data_msg;
--	tc[3]	= send_data;
--	tc[4]	= tx_empty;
--	tc[5]	= buf_res;
--	tc[6]	= ctrl_error;
--	tc[7]	= data_error;

	low_thr[7..0]	= LOW_THRESH;	-- HL-edge length after 6 clocks
	lrg_thr[9..0]	= LRG_THRESH;	-- HL-edge length after 3 clocks
	low_stp[3..0]	= LOW_STEP;	-- difference between consecutice comm. ADC samples	
	lrg_stp[7..0]	= LRG_STEP;	-- difference between consecutice comm. ADC samples	

	clev_min[9..0]	= MIN_CLEV;	-- needed for comm. DAC level adaption
	clev_max[9..0]	= MAX_CLEV;
	
	rev[15..0]		= DCFREV;

END;